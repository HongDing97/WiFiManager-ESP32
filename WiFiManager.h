//
// Created by Hong on 2021/4/11.
//

#ifndef ESP32_FRAMEWORK_WIFIMANAGER_H
#define ESP32_FRAMEWORK_WIFIMANAGER_H

#include <WiFiManager.h>
#include <WiFi.h>
#include <ESPmDNS.h>
#include <WebServer.h>
#include <Update.h>
#include <Ticker.h>
#include <vector>

const char indexHtml[] = "<!DOCTYPE html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\" /><title>Settings</title><style>body{ font-family: sans-serif; display: flex; justify-content: center;} #main{ margin-left: 10px; margin-right: 10px; width: 500px; color: #262626;} #title-box{ display: flex; padding: 20px 0 10px 0; align-items: center;} .title-content{ margin-left: 15px;} #title{ font-size: x-large; font-weight: bold;} #box{ display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 20px 20px; border-radius: 3px; margin-bottom: 25px; box-shadow: 0px 1.6px 3.6px rgb(0 0 0 / 13%), 0px 0px 2.9px rgb(0 0 0 / 11%);} #wifi-icon{ margin-right: 25px;} #box-left{ display: flex; align-items: center;} #net-info{ display: flex; flex-direction: column; justify-content: center;} #net-info-status{ display: flex; align-items: center; color: #107c10; font-size: small; font-weight: 600;} #net-info-status-notok{ display: flex; align-items: center; color: #b62c2c; font-size: small; font-weight: 600;} .status-icon{ width: 12px; margin-right: 4px;} .item{ display: flex; align-items: center; justify-content: space-between; font-weight: 600; margin-bottom: 15px; cursor: pointer;} .item-icon{ margin-right: 20px; width: 14px;} .item-arrow-btn{ display: inline-flex; align-items: center; justify-content: center; width: 25px; height: 25px; cursor: pointer; background-color: transparent; border: transparent; transition: all 0.2s;} .item-arrow-btn:hover{ border-radius: 2.5px; background-color: #f2f2f2;} .item-arrow{ width: 8px;} #footer{ display: block; text-align: center; margin-top: 40px; text-decoration: none; font-size: small; color: gray;} @media (prefers-color-scheme: dark){ body{ background: #222;} #main{ color: #eee;} #box{ background-color: #202020;} .fa-chevron-right{ color: #eee;} .item-arrow-btn:hover{ background-color: #5e5e5e;} #net-info-status{ color: #139113;} #net-info-status-notok{ color: #bb3030;}} </style></head><body><div id=\"main\"><div id=\"title-box\"><svg width=\"26px\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"user-cog\" class=\"svg-inline--fa fa-user-cog fa-w-20\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 640 512\"><path fill=\"currentColor\" d=\"M610.5 373.3c2.6-14.1 2.6-28.5 0-42.6l25.8-14.9c3-1.7 4.3-5.2 3.3-8.5-6.7-21.6-18.2-41.2-33.2-57.4-2.3-2.5-6-3.1-9-1.4l-25.8 14.9c-10.9-9.3-23.4-16.5-36.9-21.3v-29.8c0-3.4-2.4-6.4-5.7-7.1-22.3-5-45-4.8-66.2 0-3.3.7-5.7 3.7-5.7 7.1v29.8c-13.5 4.8-26 12-36.9 21.3l-25.8-14.9c-2.9-1.7-6.7-1.1-9 1.4-15 16.2-26.5 35.8-33.2 57.4-1 3.3.4 6.8 3.3 8.5l25.8 14.9c-2.6 14.1-2.6 28.5 0 42.6l-25.8 14.9c-3 1.7-4.3 5.2-3.3 8.5 6.7 21.6 18.2 41.1 33.2 57.4 2.3 2.5 6 3.1 9 1.4l25.8-14.9c10.9 9.3 23.4 16.5 36.9 21.3v29.8c0 3.4 2.4 6.4 5.7 7.1 22.3 5 45 4.8 66.2 0 3.3-.7 5.7-3.7 5.7-7.1v-29.8c13.5-4.8 26-12 36.9-21.3l25.8 14.9c2.9 1.7 6.7 1.1 9-1.4 15-16.2 26.5-35.8 33.2-57.4 1-3.3-.4-6.8-3.3-8.5l-25.8-14.9zM496 400.5c-26.8 0-48.5-21.8-48.5-48.5s21.8-48.5 48.5-48.5 48.5 21.8 48.5 48.5-21.7 48.5-48.5 48.5zM224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm201.2 226.5c-2.3-1.2-4.6-2.6-6.8-3.9l-7.9 4.6c-6 3.4-12.8 5.3-19.6 5.3-10.9 0-21.4-4.6-28.9-12.6-18.3-19.8-32.3-43.9-40.2-69.6-5.5-17.7 1.9-36.4 17.9-45.7l7.9-4.6c-.1-2.6-.1-5.2 0-7.8l-7.9-4.6c-16-9.2-23.4-28-17.9-45.7.9-2.9 2.2-5.8 3.2-8.7-3.8-.3-7.5-1.2-11.4-1.2h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c10.1 0 19.5-3.2 27.2-8.5-1.2-3.8-2-7.7-2-11.8v-9.2z\"></path></svg><span class=\"title-content\" id=\"title\">Settings</span></div><hr style=\"margin-bottom: 25px;\"><div id=\"box\"><div id=\"box-left\"><svg id=\"wifi-icon\" height=\"32px\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"wifi\" class=\"svg-inline--fa fa-wifi fa-w-20\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 640 512\"><path fill=\"currentColor\" d=\"M634.91 154.88C457.74-8.99 182.19-8.93 5.09 154.88c-6.66 6.16-6.79 16.59-.35 22.98l34.24 33.97c6.14 6.1 16.02 6.23 22.4.38 145.92-133.68 371.3-133.71 517.25 0 6.38 5.85 16.26 5.71 22.4-.38l34.24-33.97c6.43-6.39 6.3-16.82-.36-22.98zM320 352c-35.35 0-64 28.65-64 64s28.65 64 64 64 64-28.65 64-64-28.65-64-64-64zm202.67-83.59c-115.26-101.93-290.21-101.82-405.34 0-6.9 6.1-7.12 16.69-.57 23.15l34.44 33.99c6 5.92 15.66 6.32 22.05.8 83.95-72.57 209.74-72.41 293.49 0 6.39 5.52 16.05 5.13 22.05-.8l34.44-33.99c6.56-6.46 6.33-17.06-.56-23.15z\"></path></svg><div id=\"net-info\"><span style=\"font-weight: 600;\"></span><span style=\"font-size: small; margin-top:5px;\"></span><span style=\"font-size: x-small; color: gray; margin-left:1px; letter-spacing:0.7px\"></span></div></div><div><div id=\"net-info-status\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"check\" class=\"svg-inline--fa fa-check fa-w-16 status-icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"currentColor\" d=\"M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z\"></path></svg><span>Connected</span></div></div></div><div style=\"margin-left: 15px;\"><div id=\"connect2Wifi\" class=\"item\"><div class=\"item-title\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"link\" class=\"svg-inline--fa fa-link fa-w-16 item-icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"currentColor\" d=\"M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z\"></path></svg>Connect to Wi-Fi </div><button class=\"item-arrow-btn\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"chevron-right\" class=\"svg-inline--fa fa-chevron-right fa-w-10 item-arrow\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\"><path fill=\"currentColor\" d=\"M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z\"></path></svg></button></div><div id=\"update-firmware\" class=\"item\"><div class=\"item-title\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"hammer\" class=\"svg-inline--fa fa-hammer fa-w-18 item-icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 576 512\"><path fill=\"currentColor\" d=\"M571.31 193.94l-22.63-22.63c-6.25-6.25-16.38-6.25-22.63 0l-11.31 11.31-28.9-28.9c5.63-21.31.36-44.9-16.35-61.61l-45.25-45.25c-62.48-62.48-163.79-62.48-226.28 0l90.51 45.25v18.75c0 16.97 6.74 33.25 18.75 45.25l49.14 49.14c16.71 16.71 40.3 21.98 61.61 16.35l28.9 28.9-11.31 11.31c-6.25 6.25-6.25 16.38 0 22.63l22.63 22.63c6.25 6.25 16.38 6.25 22.63 0l90.51-90.51c6.23-6.24 6.23-16.37-.02-22.62zm-286.72-15.2c-3.7-3.7-6.84-7.79-9.85-11.95L19.64 404.96c-25.57 23.88-26.26 64.19-1.53 88.93s65.05 24.05 88.93-1.53l238.13-255.07c-3.96-2.91-7.9-5.87-11.44-9.41l-49.14-49.14z\"></path></svg>Update Firmware </div><button class=\"item-arrow-btn\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"chevron-right\" class=\"svg-inline--fa fa-chevron-right fa-w-10 item-arrow\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\"><path fill=\"currentColor\" d=\"M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z\"></path></svg></button></div></div></div><script>info={};var svgOK='<svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"check\" class=\"svg-inline--fa fa-check fa-w-16 status-icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"currentColor\" d=\"M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z\"></path></svg>',svgNOTOK='<svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"times\" class=\"svg-inline--fa fa-times fa-w-11 status-icon\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 352 512\"><path fill=\"currentColor\" d=\"M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z\"></path></svg>',request=new XMLHttpRequest;function writeInfo(){var e=document.getElementById(\"net-info\");e.children[0].textContent=info.ssid,e.children[1].textContent=info.ipaddr,e.children[2].textContent=info.macaddr;var n=document.getElementById(\"net-info-status\");info.isConnect?(n.innerHTML=svgOK+\"<span>Connected</span>\",n.id=\"net-info-status\"):(n.innerHTML=svgNOTOK+\"<span>Not Connected</span>\",n.id=\"net-info-status-notok\")}function prepareLinks(){document.getElementById(\"connect2Wifi\").onclick=()=>{window.open(\"/wificonfig\",\"_self\")},document.getElementById(\"update-firmware\").onclick=()=>{window.open(\"/update\",\"_self\")}}function updateNetInfo(){request.open(\"GET\",\"/getnetinfo\",!0),request.onreadystatechange=()=>{4==request.readyState&&(info=JSON.parse(request.responseText),writeInfo())},request.send(null)}window.onload=()=>{updateNetInfo(),prepareLinks()}; </script></body>";
const char connectHtml[] = "<!DOCTYPE html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\" /><title>Wi-Fi Config</title><style>body{ font-family: sans-serif; display: flex; justify-content: center;} #main{ margin-left: 10px; margin-right: 10px; width: 500px; color: #262626;} #title-box{ display: flex; padding: 20px 0 10px 0; align-items: center;} #title{ font-size: x-large; font-weight: bold;} #back-btn{ width: 30px; height: 30px; border: transparent; background-color: transparent; cursor: pointer;} #box{ padding: 20px 0 10px 0; border-radius: 4px; box-shadow: 0px 1.6px 3.6px rgb(0 0 0 / 13%), 0px 0px 2.9px rgb(0 0 0 / 11%);} #box-title{ display: flex; align-items: center; font-weight: 600; padding-left: 20px; margin-bottom: 20px;} @keyframes rotate{ 0%{ transform: rotate(0);} 100%{ transform: rotate(360deg);}} .loading{ display: inline; width: 15px; margin-left: 8px; animation: rotate 0.8s linear infinite;} .loading-small{ width: 10px;} .ssid{ display: flex; flex-direction: column; padding: 20px; border-top: #eaeaea 1px solid; font-size: small;} .ssid-top{ display: flex; align-items: center; justify-content: space-between; font-weight: 600; cursor: pointer;} .ssid-btm{ padding-right: 10px; margin-top: 15px; width: 100%;} .form{ width: 100%; display: flex; align-items: center;} .input-text{ border: 1px solid #b6b6b6; padding: 0 11px; border-radius: 2px; margin-left: 10px; margin-right: 5px; height: 32px; width: 65%; transition: all 0.2s; -webkit-appearance: none;} .input-text:hover{ border-color: #909090;} .input-text:focus:enabled{ outline: none; border-color: #838383; box-shadow: rgb(131 131 131) 0px 0px 0px 1px inset;} .sub-btn{ cursor: pointer; height: 35px; width: 25%; min-width: min-content; padding: 0 5px; transition: all 0.1s; border: 1px solid #b6b6b6; border-radius: 2px; color: #2a2a2a; background-color: #fff;} .sub-btn:hover{ border-color: #909090;} .sub-btn:active:enabled{ border-color: #cecece;} .sub-btn-disable{ cursor: not-allowed !important; opacity: 0.3;} .item-icon{ margin-right: 10px;} .item-arrow-btn{ display: inline-flex; align-items: center; justify-content: center; width: 25px; height: 25px; cursor: pointer; background-color: transparent; border: transparent; transition: all 0.2s;} .item-arrow-btn:hover{ border-radius: 2.5px; background-color: #f2f2f2;} #footer{ display: block; text-align: center; margin-top: 20px; text-decoration: none; font-size: small; color: gray;} @media (prefers-color-scheme: dark){ body{ background: #222;} #main{ color: #eee;} #box{ background-color: #202020;} #loading{ color: #fff;} .svg-inline--fa{ color: #eee;} .item-arrow-btn:hover{ background-color: #5e5e5e;} .input-text{ background-color: #333333; border-color: #737373; color: #fff;} .input-text:focus:enabled{ outline: none; border-color: #888; box-shadow: #888 0px 0px 0px 1px inset;} .sub-btn{ background-color: #333; color: #fff; border-color: #737373;} .sub-btn:active:enabled{ border-color: #5c5c5c;}} </style></head><body><div id=\"main\"><div id=\"title-box\"><button id=\"back-btn\"><svg width=\"10px\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"chevron-left\" class=\"svg-inline--fa fa-chevron-left fa-w-10\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\"><path fill=\"currentColor\" d=\"M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z\"></path></svg></button><span id=\"title\">Wi-Fi Config</span></div><hr style=\"margin-bottom: 25px;\"><div id=\"box\"><div id=\"box-title\"><span>Available Networks</span></div></div></div><script>ssids=[];var selectedIndex=-1,newSelectIndex=-1,rightSVG='<svg width=\"8px\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"chevron-right\" class=\"svg-inline--fa fa-chevron-right fa-w-10\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\"><path fill=\"currentColor\" d=\"M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z\"></path></svg>',wifiSVG='<svg width=\"16px\" style=\"margin-right:5px\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"wifi\" class=\"svg-inline--fa fa-wifi fa-w-20\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 640 512\"><path fill=\"currentColor\" d=\"M634.91 154.88C457.74-8.99 182.19-8.93 5.09 154.88c-6.66 6.16-6.79 16.59-.35 22.98l34.24 33.97c6.14 6.1 16.02 6.23 22.4.38 145.92-133.68 371.3-133.71 517.25 0 6.38 5.85 16.26 5.71 22.4-.38l34.24-33.97c6.43-6.39 6.3-16.82-.36-22.98zM320 352c-35.35 0-64 28.65-64 64s28.65 64 64 64 64-28.65 64-64-28.65-64-64-64zm202.67-83.59c-115.26-101.93-290.21-101.82-405.34 0-6.9 6.1-7.12 16.69-.57 23.15l34.44 33.99c6 5.92 15.66 6.32 22.05.8 83.95-72.57 209.74-72.41 293.49 0 6.39 5.52 16.05 5.13 22.05-.8l34.44-33.99c6.56-6.46 6.33-17.06-.56-23.15z\"></path></svg>',loadingSVG='<svg data-name=\"Capa 1\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 32 29\"><path fill=\"currentColor\" d=\"M27,3a2.73,2.73,0,0,0-3.77,0,2.68,2.68,0,0,0,0,3.77,9.91,9.91,0,0,1,2.14,11A10.1,10.1,0,0,1,15.9,24a10.36,10.36,0,0,1-9.7-6.23A10,10,0,0,1,8.08,6.82,2.66,2.66,0,0,0,8,3.06a2.75,2.75,0,0,0-3.77.12A15.21,15.21,0,0,0,1.31,19.85,15.62,15.62,0,0,0,15.9,29.29a15.33,15.33,0,0,0,14.41-9.53A15.16,15.16,0,0,0,27,3Z\" /></svg>',loading=document.createElement(\"span\");loading.innerHTML=loadingSVG,loading.setAttribute(\"class\",\"loading\");var request=new XMLHttpRequest;function writeSSIDs(){for(var e=document.getElementById(\"box\"),t=0;t<ssids.length;t++){var n=document.createElement(\"div\");n.setAttribute(\"class\",\"ssid\"),e.appendChild(n);var a=document.createElement(\"div\");a.setAttribute(\"id\",\"ssid\"+t.toString()),a.setAttribute(\"class\",\"ssid-top\"),n.appendChild(a);var s=document.createElement(\"div\");s.style.display=\"flex\",s.style.alignItems=\"center\";var l=document.createElement(\"span\");l.innerHTML=wifiSVG,s.appendChild(l),s.appendChild(document.createTextNode(ssids[t])),a.appendChild(s);var d=document.createElement(\"button\");d.setAttribute(\"class\",\"item-arrow-btn\"),a.appendChild(d);var i=document.createElement(\"span\");i.setAttribute(\"class\",\"item-arrow\"),i.innerHTML=rightSVG,d.appendChild(i);var o=document.createElement(\"span\");o.innerHTML=loadingSVG,o.className=\"loading loading-small\",o.style.display=\"none\";var r=document.createElement(\"div\");r.setAttribute(\"class\",\"ssid-btm\"),n.appendChild(r),r.style.display=\"none\";var c=document.createElement(\"form\");c.setAttribute(\"id\",\"form\"+t),c.setAttribute(\"class\",\"form\"),c.setAttribute(\"onsubmit\",\"return false;\"),r.appendChild(c),c.appendChild(o);var u=document.createElement(\"input\");u.setAttribute(\"type\",\"password\"),u.setAttribute(\"placeholder\",\"Password Here\"),u.setAttribute(\"class\",\"input-text\"),c.appendChild(u);var m=document.createElement(\"button\");m.setAttribute(\"class\",\"sub-btn sub-btn-disable\"),m.setAttribute(\"type\",\"button\"),m.appendChild(document.createTextNode(\"Connect\")),m.onclick=connect,u.relativeButton=m,u.oninput=e=>{e.target.value.length>0?e.target.relativeButton.className=\"sub-btn\":e.target.relativeButton.className=\"sub-btn sub-btn-disable\"},c.appendChild(m)}}function prepareLinks(){for(var e=document.getElementsByClassName(\"ssid-top\"),t=0;t<e.length;t++)e[t].onclick=onClickSSID}function onClickSSID(){var e=document.getElementsByClassName(\"ssid-top\");for(var t in e)if(this==e[t]){newSelectIndex=t;break}return updateSelect(),!1}function updateSelect(){if(newSelectIndex<0||newSelectIndex==selectedIndex&&-1!=newSelectIndex)return!1;selectedIndex>=0&&(document.getElementsByClassName(\"ssid-btm\")[selectedIndex].style.display=\"none\",document.getElementsByClassName(\"item-arrow-btn\")[selectedIndex].style.backgroundColor=\"\"),selectedIndex=newSelectIndex;var e=document.getElementsByClassName(\"ssid-btm\")[newSelectIndex],t=document.getElementsByTagName(\"input\")[newSelectIndex];t.value=null,t.relativeButton.className=\"sub-btn sub-btn-disable\",e.style.display=\"block\",setTimeout((()=>{document.getElementsByClassName(\"item-arrow-btn\")[newSelectIndex].style.backgroundColor=\"transparent\"}),150)}function connect(){var e=document.getElementsByClassName(\"loading loading-small\")[selectedIndex];e.style.display=\"inline\";var t=document.getElementsByTagName(\"input\")[selectedIndex];if(0==t.value.length)return!1;var n=document.getElementsByClassName(\"ssid-top\")[selectedIndex].childNodes[0].childNodes[1].textContent,a=t.value,s=new XMLHttpRequest;return s.open(\"POST\",\"/connect\",!0),s.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\"),s.send(\"ssid=\"+n+\"&password=\"+a),s.onreadystatechange=()=>{4==s.readyState&&(\"OK\"==s.responseText?(alert(\"Connected to \"+n+\".\"),window.open(\"/\",\"_self\")):\"UNSURE\"==s.responseText?(alert(\"Please manually check the connection later.\"),window.open(\"about:blank\",\"_self\")):(alert(\"Connect error, check the SSID and the password.\"),e.style.display=\"none\"))},!1}function loadingAnimation(e){loading.style.display=e?\"inline\":\"none\"}function updateSSIDs(){request.open(\"GET\",\"/getssids\",!0),loadingAnimation(!0),request.onreadystatechange=()=>{4==request.readyState&&(ssids=JSON.parse(request.responseText),writeSSIDs(),prepareLinks(),loadingAnimation(!1))},request.send(null)}window.onload=()=>{document.getElementById(\"box-title\").appendChild(loading),document.getElementById(\"back-btn\").onclick=()=>{window.open(\"/\",\"_self\")},updateSSIDs()}; </script></body>";
const char updateHtml[] = "<!DOCTYPE html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\" /><title>Firmware Update</title><style>body{ font-family: sans-serif; display: flex; justify-content: center;} #main{ margin-left: 10px; margin-right: 10px; width: 500px; color: #262626;} #title-box{ display: flex; padding: 20px 0 10px 0; align-items: center;} #title{ font-size: x-large; font-weight: bold;} #back-btn{ width: 30px; height: 30px; border: transparent; background-color: transparent; cursor: pointer;} #box{ padding: 20px; border-radius: 4px; box-shadow: 0px 1.6px 3.6px rgb(0 0 0 / 13%), 0px 0px 2.9px rgb(0 0 0 / 11%);} #box-top{ display: flex; align-items: center; width: 100%; margin-bottom: 15px;} #fileopen-icon{ width: 18px; margin-right: 8px;} #file{ display: inline-flex; padding: 0px 10px; align-items: center; justify-content: space-between; cursor: pointer; width: 100%; height: 35px; transition: all 0.1s; border: 1px solid #b6b6b6; border-radius: 2px; color: #2a2a2a; background-color: #fff;} #file:hover{ border-color: #909090;} #box-btm{ display: flex; align-items: center; padding-left: 25px; justify-content: space-between;} #upload{ cursor: pointer; height: 35px; padding: 0 20px; transition: all 0.1s; border: 1px solid #b6b6b6; border-radius: 2px; color: #2a2a2a; background-color: #fff;} #upload:hover{ border-color: #909090;} #upload:active:enabled{ border-color: #cecece;} #file-name{ font-size: small;} @media (prefers-color-scheme: dark){ body{ background: #222;} #main{ color: #eee;} #box{ background-color: #202020;} #back-btn{ color: #fff;} #box-btm{ display: flex; flex-direction: row-reverse;} #file{ background-color: #333333; border-color: #737373; color: #fff;} #upload{ background-color: #333; color: #fff; border-color: #737373;} #upload:active:enabled{ border-color: #5c5c5c;} #opt-icon{ color: #fff;} #progress{ background-color: #0875c9;} #progress-index{ color: #777;}} </style></head><body><div id=\"main\"><div id=\"title-box\"><button id=\"back-btn\" onclick=\"window.open('/','_self')\"><svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"chevron-left\" class=\"svg-inline--fa fa-chevron-left fa-w-10\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 320 512\"><path fill=\"currentColor\" d=\"M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z\"></path></svg></button><span id=\"title\">Firmware Update</span></div><hr style=\"margin-bottom: 25px;\"><div id=\"box\"><div id=\"box-top\"><svg id=\"fileopen-icon\" aria-hidden=\"true\" focusable=\"false\" data-prefix=\"far\" data-icon=\"folder-open\" class=\"svg-inline--fa fa-folder-open fa-w-18\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 576 512\"><path fill=\"currentColor\" d=\"M527.9 224H480v-48c0-26.5-21.5-48-48-48H272l-64-64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h400c16.5 0 31.9-8.5 40.7-22.6l79.9-128c20-31.9-3-73.4-40.7-73.4zM48 118c0-3.3 2.7-6 6-6h134.1l64 64H426c3.3 0 6 2.7 6 6v42H152c-16.8 0-32.4 8.8-41.1 23.2L48 351.4zm400 282H72l77.2-128H528z\"></path></svg><form id=\"form\" method='POST' action='/upload' enctype='multipart/form-data' style=\"display: none;\"><input id=\"file-input\" type='file' name='update' onchange=\"onFileInputClick(this.files)\"><input type='submit' value='Update'></form><div id=\"file\"><span id=\"file-name\">Upload File Here</span><svg id=\"opt-icon\" width=\"20\" height=\"20\" fill=\"currentColor\" viewBox=\"0 0 20 20\"><path d=\"M6 10a1.25 1.25 0 11-2.5 0A1.25 1.25 0 016 10z\"></path><path d=\"M11.25 10a1.25 1.25 0 11-2.5 0 1.25 1.25 0 012.5 0z\"></path><path d=\"M15.25 11.25a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z\"></path></svg></div></form></div><div id=\"box-btm\"><button id=\"upload\" type=\"button\">Upload</button></div></div></div><script>var uploadBtn,selectFile,form,file,fileName,fileChoosed=!1;function linkElem(){uploadBtn=document.getElementById(\"upload\"),selectFile=document.getElementById(\"file\"),form=document.getElementById(\"form\"),file=document.getElementById(\"file-input\"),fileName=document.getElementById(\"file-name\")}function setHandler(){uploadBtn.onclick=onBtnClick,selectFile.onclick=onSelectFile}function onBtnClick(){return fileChoosed&&(setTimeout((()=>{alert(\"Uploading...Please wait until the device is fully rebooted.\")}),100),form.submit()),!1}function onFileInputClick(e){return fileName.innerText=e[0].name,fileName.style.fontWeight=600,fileChoosed=!0,!1}function onSelectFile(){return file.click(),!1}window.onload=()=>{linkElem(),setHandler()}; </script></body>";

const int maxRetryTimes = 120;

const IPAddress apIP(192, 168, 4, 1);
const IPAddress apGateway(192, 168, 4, 1);
const IPAddress apSubMask(255, 255, 255, 0);

class WiFiManager {
private:
    bool connectStatus = false;
    bool wifiSpecified = false;
    String ipAddr;
    String macAddr;
    String macAddrPrefix;
    String apSSID;
    WebServer server;
    Ticker ticker;
    std::function<void(void)> onConnectHandler;
    std::function<void(bool)> onAfterConnectHandler;
    std::function<void(void)> onScanHandler;
    std::function<void(void)> onAfterScanHandler;
    std::function<void(String, String)> onAPOpenHandler;


    void runServer();

    void scan();

public:
    String ssid = "N/A";
    String password = "";

    std::vector<String> networks;

    WiFiManager();

    bool connect(bool autoConnect = false);

    bool isConnected();

    void specifyWiFi(String ssid, String password);

    const String &getIpAddr() const;

    void start();

    void run();

    void setOnConnectHandler(const std::function<void(void)> &onConnectHandler);

    void setOnAfterConnectHandler(const std::function<void(bool)> &onAfterConnectHandler);

    void setOnScanHandler(const std::function<void(void)> &onScanHandler);

    void setOnAfterScanHandler(const std::function<void(void)> &onAfterScanHandler);

    void setOnApOpenHandler(const std::function<void(String, String)> &onApOpenHandler);
};

#endif //ESP32_FRAMEWORK_WIFIMANAGER_H
